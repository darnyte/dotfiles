#!/usr/bin/env bash

# Make a HTTP POST request
http_request_post() {
	cat <<EOF >&6
POST $QUERY HTTP/1.1$CR
User-Agent:$AGENT$CR
Host:$HOST$CR
Accept:$ACCEPT$CR
Accept-Language:$ACCEPT_LANGUAGE$CR
Accept-Encoding:$ACCEPT_ENCODING$CR
Connection:close$CR
$CR
${PAYLOAD:-$(cat)}$CR
$CR
EOF
}

# Make a HTTP GET request
http_request_get() {
	cat <<EOF >&6
GET $QUERY HTTP/1.1$CR
User-Agent:$AGENT$CR
Host:$HOST$CR
Accept:$ACCEPT$CR
Accept-Language:$ACCEPT_LANGUAGE$CR
Accept-Encoding:$ACCEPT_ENCODING$CR
Connection:close$CR
$CR
EOF
}

# Make a HTTP request and dump response
#
# @param 1 - URL
# @param 2 - port (optional)
http() {
	local CR=$'\r'
	local REQUEST=${REQUEST:-http_request_get}
	local AGENT=${AGENT:-"bash/$BASH_VERSION ($(uname -sm))"}
	local ACCEPT=${ACCEPT:-'text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/webp, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1'}
	local ACCEPT_LANGUAGE=${ACCEPT_LANGUAGE:-'en'}
	local ACCEPT_ENCODING=${ACCEPT_ENCODING:-'gzip, deflate'}
	local HOST=${1#http://} QUERY='/'

	[[ $HOST == */* ]] && {
		QUERY='/'${HOST#*/}
		HOST=${HOST%%/*}
	}

	exec 6<>/dev/tcp/"$HOST"/"${2:-80}"

	$REQUEST && cat <&6

	exec 6>&-
	exec 6<&-
}

if [ "${BASH_SOURCE[0]}" == "$0" ]
then
	http "$@"
fi
