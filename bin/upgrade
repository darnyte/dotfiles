#!/usr/bin/env bash

backup_package_list() {
	[ "$BACKUP_HOME" ] || return 0
	local NAME
	NAME=$(uname -mns)
	NAME=${NAME// /_}
	local TMP="${0##*/}-$$.tmp"
	cat > "$TMP"
	scp "$TMP" "${BACKUP_HOME}sets/$NAME"
	rm -f "$TMP"
}

type brew &>/dev/null && {
	brew update && brew upgrade && brew cleanup &&
		brew list | backup_package_list
	exit $?
}

type emerge &>/dev/null && {
	emerge --sync && emerge -uDU --with-bdeps=y @world &&
		emerge -av --depclean && revdep-rebuild && eclean-dist &&
		equery list | backup_package_list
	exit $?
}

# check apt before apt-get because Termux also knows apt-get
type apt &>/dev/null && {
	apt update && apt upgrade && apt autoclean &&
		apt list | backup_package_list
	exit $?
}

type apt-get &>/dev/null && {
	sudo apt-get update && sudo apt-get upgrade && sudo apt-get autoclean &&
		dpkg-query -l | backup_package_list
	exit $?
}
