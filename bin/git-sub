#!/usr/bin/env bash

# Update subtree from remote name
#
# @param 1 - name of remote
update()
{
	[ "$1" ] || return $?

	git fetch --no-tags "$1" &&
		git merge -s subtree --squash "$1/master"
}

# Add (or update) a subtree from a repository URL
#
# @param 1 - URL of repository
# @param 2 - prefix for repository directory (optional)
add()
{
	local NAME=${1##*/}
	NAME=${NAME%.*}

	[ "$NAME" ] || return $?

	if git remote | fgrep "$NAME" &>/dev/null
	then
		update "$NAME"
	else
		git remote add "$NAME" "$1" &&
			git fetch --no-tags "$NAME" &&
			git read-tree --prefix="$2$NAME/" -u "$NAME/master"
	fi
}

# Print help
help()
{
	cat <<EOF
usage: git sub add    <repository> <prefix>
   or: git sub update <remote>
EOF
}

if [ "$0" == "${BASH_SOURCE[0]}" ]
then
	"${@:-help}"
fi
